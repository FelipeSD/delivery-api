name: CI/CD - Delivery API

on:
  push:
    branches: [ main ]

# ğŸ” Usa o environment "prod" para acessar secrets seguras
env:
  SPRING_PROFILES_ACTIVE: prod

jobs:
  # ==========================
  # ğŸ§± 1ï¸âƒ£ Build + Testes
  # ==========================
  build_and_test:
    name: ğŸ§ª Build e Testes
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: ğŸ“¦ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ”§ Cache do Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ğŸ§© Compilar e rodar testes
        run: mvn clean verify -Dspring.profiles.active=test

      - name: âœ… Verificar resultados dos testes
        if: success()
        run: echo "âœ… Testes concluÃ­dos com sucesso!"

  # ==========================
  # ğŸ³ 2ï¸âƒ£ Build da imagem Docker
  # ==========================
  docker_build:
    name: ğŸ³ Build da Imagem Docker
    runs-on: ubuntu-latest
    needs: build_and_test   # SÃ³ executa se os testes passaram
    environment: prod

    steps:
      - name: ğŸ“¦ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ§° Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ” Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build e Push da imagem
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/delivery-api:latest
            ${{ secrets.DOCKER_USERNAME }}/delivery-api:${{ github.run_number }}

  # ==========================
  # ğŸš€ 3ï¸âƒ£ Deploy (manual ou automÃ¡tico)
  # ==========================
  deploy:
    name: ğŸš€ Deploy de ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: docker_build     # SÃ³ executa se o Docker build for bem-sucedido
    environment:
      name: prod
      url: https://meu-servidor-deploy.com   # opcional, mostra link no Actions UI

    steps:
      - name: ğŸ“¡ Deploy automÃ¡tico
        run: |
          echo "Iniciando deploy..."
          # Exemplo de deploy remoto via SSH:
          # ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          #   "docker pull ${{ secrets.DOCKER_USERNAME }}/delivery-api:latest && docker compose up -d"
          echo "âœ… Deploy finalizado com sucesso!"
